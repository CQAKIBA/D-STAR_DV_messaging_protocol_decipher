Protocol analysis project for RS-MS1A Text mode
Copyright (c) 2025 Daisuke JA1UMW / CQAKIBA.TOKYO
Apache License 2.0

ICOM製 D-STAR メッセージングソフトウェア RS-MS1A 及び 同機能を有する無線機と通信するためのプロトコル解析情報です。

この解析情報を用いる事で、ICOM製公式アプリケーション及び、D-STAR無線機に標準搭載されている機能を用いて、
メッセージングアプリケーションの開発、ニュース等の情報配信、
AIチャットボットとの接続、リモートコマンド操作、その他各種サービスが実現される事を期待しています。

この解析情報について、メーカー及び関係機関に問い合わせる行為はただの迷惑ですので行わないでください。

=== 実機の挙動、D-STAR仕様書、その他Wikipedia等から判明している仕様 ===
・ 単純なシリアル通信、XON/XOFFフロー制御。
・ XON/XOFFに関連、及び、いくつかの制御コードのエスケープシーケンス。（D-STAR仕様書を参照）
・ 一方向送りっぱなし、ACKなし。自動再送なし。
・ 全てのD-STAR無線機間で単純な全透過。（D-STAR仕様）
・ 要するにクロスケーブル直結でも動作、つまりD-STARじゃなくても自作の無線機でそのまま...おっと誰か来たようだ。

=== テキスト伝送 ===

データサンプル

24 24 4D 73 67 2C 4A 53 31 59 43 50 2C 43 51 43 51 43 51 2C 30 30 31 31 39 30 E3 81 82 E3 81 84 E3 81 86 E3 81 88 E3 81 8A 92 0D 00
24 24 4D 73 67 2C 4A 53 31 59 43 50 2C 43 51 43 51 43 51 2C 30 30 31 31 39 30 E3 83 86 E3 82 B9 E3 83 88 F8 0D 00

解析
UTF-8でデコードすると以下の通りになる。但し、一部に謎の数値、バイナリ値が含まれている。

$$Msg,JS1YCP,CQCQCQ,001190あいうえお[0x92][0x0D(CR)][0x00(NULL)]
$$Msg,JS1YCP,CQCQCQ,001190テスト[0xF8][0x0D(CR)][0x00(NULL)]

おおよそ分解すると次の通りに解釈できる。
$$Msg,       - ヘッダ
JS1YCP,      - 自局コールサイン
CQCQCQ,      - 宛先
001190       - 不明な数値(テキスト)
あいうえお    - ペイロード(UTF-8)
[0x92]       - 不明な数値(バイナリ)
[0x0D(CR)]   - CR改行
[0x00(NULL)] - 終端

この状態から、文字部分を改変すると受信側で表示(デコード)されなくなるため、数値部分に何らかの仕掛けがある事が推測される。
おそらくチェックサムの可能性が高いと考え、推定を行う。

多数のサンプルパターンを収集し、以下の計算式を特定した。

末尾付近のバイナリ値について
メッセージの変化のみに連動し、文字コードと単純な比例関係である事がわかった。
sum(E3 81 82 E3 81 84 E3 81 86 E3 81 88 E3 81 8A) = 992
sum(E3 83 86 E3 82 B9 E3 83 88) = 5F8
よって、バイナリ値は 「 ペイロードの総和 & 0xFF 」 である事がわかりました。

不明な数値(テキスト)について
001190の内、90部分がコールサインと宛先で変化し、文字コードと単純な比例関係である事がわかった。
コールサイン+宛先の総和から+26のオフセットしている事まではわかったが、26の根拠は不明。
暫定的に、「 (コールサインの文字コードの総和 + 宛先の文字コードの総和 + 26) & 0xFF 」でいける事が確認できた。

001190の内、0011部分については現時点では不明であるが、0011固定値で正常に受信される事が確認できたため、一旦放置とする。

テストプログラム
Teratermマクロを生成する検証用のPHPコードを作成した。
